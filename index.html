<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eisenhower Matrix</title>
<style>
/* Reset and base styles */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

/* Header styles */
.header {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

h1 {
  margin: 0;
  flex: 1;
  color: #333;
  font-size: 28px;
  background: linear-gradient(90deg, #667eea, #764ba2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Button styles */
.add-btn {
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(90deg, #667eea, #764ba2);
  color: white;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: transform 0.2s, box-shadow 0.2s;
}

.add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.add-btn.secondary {
  background: linear-gradient(90deg, #f093fb, #f5576c);
}

.add-btn.secondary:hover {
  box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
}

.clear-data-btn {
  padding: 10px 16px;
  border: 2px solid #f5576c;
  border-radius: 8px;
  background: white;
  color: #f5576c;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s;
}

.clear-data-btn:hover {
  background: #f5576c;
  color: white;
}

/* Matrix grid */
.matrix {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  gap: 20px;
  height: calc(100vh - 180px);
  min-height: 600px;
}

/* Quadrant styles */
.quadrant {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: transform 0.3s;
}

.quadrant:hover {
  transform: translateY(-5px);
}

.quadrant h2 {
  margin: 0 0 15px;
  font-size: 18px;
  color: #333;
  padding-bottom: 10px;
  border-bottom: 2px solid;
}

/* Quadrant specific colors */
.q1 { border-top: 6px solid #ff6b6b; }
.q1 h2 { border-bottom-color: #ff6b6b; color: #ff6b6b; }

.q2 { border-top: 6px solid #4ecdc4; }
.q2 h2 { border-bottom-color: #4ecdc4; color: #4ecdc4; }

.q3 { border-top: 6px solid #ffd166; }
.q3 h2 { border-bottom-color: #ffd166; color: #ffd166; }

.q4 { border-top: 6px solid #9d9d9d; }
.q4 h2 { border-bottom-color: #9d9d9d; color: #9d9d9d; }

/* Group styles */
.group-container {
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  margin-bottom: 15px;
  background: #fafafa;
  overflow: hidden;
  box-shadow: 0 3px 10px rgba(0,0,0,0.05);
}

.group-container.dragging {
  opacity: 0.5;
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
}

.group-header {
  font-weight: bold;
  padding: 12px 15px;
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: grab;
  user-select: none;
}

.group-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.group-menu {
  position: relative;
}

.group-dots {
  cursor: pointer;
  padding: 5px 10px;
  font-weight: bold;
  color: white;
  opacity: 0.8;
  font-size: 18px;
}

.group-dots:hover {
  opacity: 1;
}

.group-menu-content {
  display: none;
  position: absolute;
  right: 0;
  top: 25px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.15);
  overflow: hidden;
  z-index: 1000;
  min-width: 150px;
}

.group-menu-content.show {
  display: block;
}

.group-menu-content div {
  padding: 12px 15px;
  cursor: pointer;
  white-space: nowrap;
  color: #333;
  transition: background 0.2s;
}

.group-menu-content div:hover {
  background: #f0f0f0;
}

.group-tasks {
  padding: 10px 15px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 300px;
  overflow-y: auto;
}

/* Task styles */
.task {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: white;
  padding: 12px 15px;
  border-radius: 8px;
  font-size: 14px;
  cursor: grab;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  transition: transform 0.2s, box-shadow 0.2s;
  border-left: 4px solid #667eea;
}

.task:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.task.dragging {
  opacity: 0.5;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.task-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.group-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
}

.task-menu {
  position: relative;
}

.dots {
  cursor: pointer;
  padding: 5px 10px;
  font-weight: bold;
  color: #666;
  font-size: 18px;
}

.menu {
  display: none;
  position: absolute;
  right: 0;
  top: 25px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.15);
  overflow: hidden;
  z-index: 1000;
  min-width: 120px;
}

.menu.show {
  display: block;
}

.menu div {
  padding: 12px 15px;
  cursor: pointer;
  white-space: nowrap;
  color: #333;
  transition: background 0.2s;
}

.menu div:hover {
  background: #f0f0f0;
}

/* Modal styles */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 20px;
}

.modal.show {
  display: flex;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: 15px;
  width: 100%;
  max-width: 400px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 50px rgba(0,0,0,0.2);
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-content h3 {
  margin: 0 0 20px;
  color: #333;
  font-size: 22px;
}

/* Form styles */
label {
  display: block;
  margin: 15px 0 5px;
  font-weight: 600;
  color: #555;
}

input[type="text"],
input[type="color"],
select {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.2s;
  margin-top: 5px;
}

input[type="text"]:focus,
select:focus {
  outline: none;
  border-color: #667eea;
}

input[type="checkbox"] {
  margin-right: 10px;
  transform: scale(1.2);
}

/* Modal actions */
.modal-actions {
  margin-top: 25px;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.modal-actions button {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s;
}

.modal-actions button:first-child {
  background: #f0f0f0;
  color: #666;
}

.modal-actions button:first-child:hover {
  background: #e0e0e0;
}

.modal-actions button:last-child {
  background: linear-gradient(90deg, #667eea, #764ba2);
  color: white;
}

.modal-actions button:last-child:hover {
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

/* Delete group modal */
.delete-group-actions {
  margin-top: 25px;
}

.delete-group-btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(90deg, #ff6b6b, #f06595);
  color: white;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  margin-top: 10px;
  transition: transform 0.2s, box-shadow 0.2s;
}

.delete-group-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
}

/* Sync container */
.sync-container {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.sync-status {
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  background: #f0f0f0;
  color: #666;
  min-width: 100px;
  text-align: center;
}

.sync-status.syncing {
  background: #fff3cd;
  color: #856404;
}

.sync-status.online {
  background: #d4edda;
  color: #155724;
}

.sync-status.offline {
  background: #f8d7da;
  color: #721c24;
}

.google-drive-btn {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(90deg, #4285F4, #34A853);
  color: white;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: transform 0.2s, box-shadow 0.2s;
}

.google-drive-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(66, 133, 244, 0.4);
}

.google-drive-btn.signed-in {
  background: linear-gradient(90deg, #34A853, #0F9D58);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-left: 10px;
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 2px solid white;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Sync options */
.sync-options-container {
  position: relative;
}

.sync-options {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  padding: 15px;
  z-index: 1000;
  margin-top: 5px;
  min-width: 180px;
}

.sync-options.show {
  display: block;
  animation: fadeIn 0.2s;
}

.sync-options button {
  display: block;
  width: 100%;
  padding: 12px;
  margin-bottom: 8px;
  border: none;
  border-radius: 6px;
  background: #f8f9fa;
  color: #333;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  text-align: left;
  transition: background 0.2s;
}

.sync-options button:hover {
  background: #e9ecef;
}

.sync-options hr {
  margin: 12px 0;
  border: none;
  border-top: 1px solid #e0e0e0;
}

/* Responsive design */
@media (max-width: 768px) {
  .matrix {
    grid-template-columns: 1fr;
    grid-template-rows: repeat(4, 1fr);
    height: auto;
    min-height: 800px;
  }
  
  .header {
    flex-direction: column;
    align-items: stretch;
  }
  
  h1 {
    text-align: center;
  }
  
  .sync-container {
    justify-content: center;
  }
}

/* Scrollbar styles */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1;
}

/* Quadrant scroll */
.quadrant {
  overflow-y: auto;
}

/* Instructions */
.instructions {
  text-align: center;
  color: #666;
  font-size: 14px;
  margin-top: 10px;
  padding: 10px;
  background: rgba(255,255,255,0.9);
  border-radius: 8px;
}
</style>
</head>
<body>

<div class="header">
  <h1>Eisenhower Matrix</h1>
  
  <div class="sync-container">
    <span class="sync-status" id="syncStatus">Offline</span>
    
    <div class="sync-options-container">
      <button class="google-drive-btn" id="googleDriveBtn" onclick="toggleSyncOptions()">
        <span>G</span>
        <span id="driveBtnText">Sync with Drive</span>
      </button>
      
      <div class="sync-options" id="syncOptions">
        <div style="margin-bottom: 10px; font-weight: bold;">Google Drive Sync</div>
        <button onclick="signInWithGoogle()" id="signInBtn">Sign in with Google</button>
        <button onclick="signOutFromGoogle()" id="signOutBtn" style="display: none;">Sign out</button>
        <hr>
        <button onclick="forceSyncToDrive()">Sync Now</button>
        <button onclick="loadFromDrive()">Load from Drive</button>
      </div>
    </div>
    
    <div class="user-info" id="userInfo" style="display: none;">
      <img id="userAvatar" class="user-avatar" src="" alt="">
      <span id="userName"></span>
    </div>
    
    <button class="clear-data-btn" onclick="clearAllData()">Clear All</button>
    <button class="add-btn secondary" onclick="openGroupModal()">+ Add Group</button>
    <button class="add-btn" onclick="openTaskModal()">+ Add Task</button>
  </div>
</div>

<div class="instructions">
  Drag tasks between quadrants to re-prioritize. Drag groups to move all tasks together.
</div>

<div class="matrix">
  <div class="quadrant q1" id="q1">
    <h2>Important & Urgent</h2>
    <div class="quadrant-content"></div>
  </div>
  <div class="quadrant q2" id="q2">
    <h2>Important & Not Urgent</h2>
    <div class="quadrant-content"></div>
  </div>
  <div class="quadrant q3" id="q3">
    <h2>Not Important & Urgent</h2>
    <div class="quadrant-content"></div>
  </div>
  <div class="quadrant q4" id="q4">
    <h2>Not Important & Not Urgent</h2>
    <div class="quadrant-content"></div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal" id="taskModal">
  <div class="modal-content">
    <h3>Add / Edit Task</h3>
    <label>Task name</label>
    <input type="text" id="taskName" placeholder="Enter task name">
    
    <label style="margin-top: 20px;">
      <input type="checkbox" id="important"> Important
    </label>
    
    <label>
      <input type="checkbox" id="urgent"> Urgent
    </label>
    
    <label>Group</label>
    <select id="taskGroup">
      <option value="">No Group</option>
    </select>
    
    <div class="modal-actions">
      <button onclick="closeTaskModal()">Cancel</button>
      <button onclick="saveTask()">Save Task</button>
    </div>
  </div>
</div>

<!-- Group Modal -->
<div class="modal" id="groupModal">
  <div class="modal-content">
    <h3 id="groupModalTitle">Add Group</h3>
    
    <label>Group name</label>
    <input type="text" id="groupName" placeholder="Enter group name">
    
    <label>Group color</label>
    <input type="color" id="groupColor" value="#667eea">
    
    <div class="modal-actions">
      <button onclick="closeGroupModal()">Cancel</button>
      <button onclick="saveGroup()" id="saveGroupBtn">Add Group</button>
    </div>
  </div>
</div>

<!-- Delete Group Modal -->
<div class="modal" id="deleteGroupModal">
  <div class="modal-content">
    <h3>Delete Group</h3>
    <p>Are you sure you want to delete the group "<span id="deleteGroupName"></span>"?</p>
    
    <div class="delete-group-actions">
      <label style="display: flex; align-items: center; margin: 10px 0;">
        <input type="radio" name="deleteOption" value="deleteTasks" checked style="margin-right: 10px;">
        Delete all tasks in this group
      </label>
      
      <label style="display: flex; align-items: center; margin: 10px 0;">
        <input type="radio" name="deleteOption" value="keepTasks" style="margin-right: 10px;">
        Keep tasks (they will become ungrouped)
      </label>
      
      <button class="delete-group-btn" onclick="confirmDeleteGroup()">Delete Group</button>
      <button onclick="closeDeleteGroupModal()" style="margin-top: 10px; width: 100%; background: #f0f0f0; color: #666;">Cancel</button>
    </div>
  </div>
</div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const GOOGLE_CONFIG = {
  // Replace these with your Google Cloud credentials
  clientId: 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com',
  apiKey: 'YOUR_API_KEY_HERE'
};

const STORAGE_KEY = 'eisenhowerMatrixData';
const FILE_VERSION = '1.0';
const SYNC_FILE_NAME = 'eisenhower-matrix.json';

// ============================================
// STATE MANAGEMENT
// ============================================
let groups = {};
let editingTask = null;
let editingGroup = null;
let deletingGroup = null;
let googleUser = null;
let syncInProgress = false;
let lastSyncTime = null;

// ============================================
// INITIALIZATION
// ============================================
function initializeApp() {
  console.log('Initializing app...');
  
  // Load from localStorage
  const savedData = localStorage.getItem(STORAGE_KEY);
  if (savedData) {
    try {
      const data = JSON.parse(savedData);
      loadData(data);
      console.log('Data loaded from localStorage');
    } catch (e) {
      console.error('Error loading saved data:', e);
    }
  }
  
  // Check for Google token
  const savedToken = localStorage.getItem('googleDriveToken');
  if (savedToken) {
    try {
      googleUser = JSON.parse(savedToken);
      updateAuthUI(true);
      
      const savedUserInfo = localStorage.getItem('googleUserInfo');
      if (savedUserInfo) {
        const userInfo = JSON.parse(savedUserInfo);
        document.getElementById('userAvatar').src = userInfo.picture || '';
        document.getElementById('userName').textContent = userInfo.name || userInfo.email;
      }
    } catch (e) {
      console.error('Error loading Google token:', e);
    }
  }
  
  // Initialize drag and drop
  initializeDragAndDrop();
  
  console.log('App initialized successfully');
}

function initializeDragAndDrop() {
  document.querySelectorAll('.quadrant').forEach(q => {
    q.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    });
    
    q.addEventListener('drop', handleDrop);
  });
}

function handleDrop(e) {
  e.preventDefault();
  const draggedElement = document.querySelector('.task.dragging, .group-container.dragging');
  
  if (!draggedElement) return;
  
  const targetQuadrant = e.currentTarget;
  const targetContent = targetQuadrant.querySelector('.quadrant-content');
  
  if (draggedElement.classList.contains('group-container')) {
    // Dragging a group
    draggedElement.classList.remove('dragging');
    targetContent.appendChild(draggedElement);
  } else if (draggedElement.classList.contains('task')) {
    // Dragging a task
    draggedElement.classList.remove('dragging');
    const groupContainer = draggedElement.closest('.group-container');
    
    if (groupContainer) {
      // Task is in a group
      const groupName = groupContainer.dataset.name;
      const existingGroup = targetQuadrant.querySelector(`.group-container[data-name="${groupName}"]`);
      
      if (existingGroup) {
        existingGroup.querySelector('.group-tasks').appendChild(draggedElement);
      } else {
        // Create new group in target quadrant
        createGroupContainer(groupName, targetQuadrant);
        targetQuadrant.querySelector(`.group-container[data-name="${groupName}"] .group-tasks`).appendChild(draggedElement);
      }
      
      // Remove task from source group
      groupContainer.querySelector('.group-tasks').removeChild(draggedElement);
      
      // Remove empty group
      if (groupContainer.querySelectorAll('.task').length === 0) {
        groupContainer.remove();
      }
    } else {
      // Task is not in a group
      targetContent.appendChild(draggedElement);
    }
  }
  
  saveToStorage();
}

// ============================================
// TASK MANAGEMENT
// ============================================
function openTaskModal(task = null) {
  console.log('Opening task modal');
  editingTask = task;
  document.getElementById('taskModal').classList.add('show');
  
  if (!task) {
    // New task
    document.getElementById('taskName').value = '';
    document.getElementById('important').checked = false;
    document.getElementById('urgent').checked = false;
    document.getElementById('taskGroup').value = '';
  } else {
    // Edit existing task
    document.getElementById('taskName').value = task.dataset.name;
    document.getElementById('important').checked = task.dataset.important === 'true';
    document.getElementById('urgent').checked = task.dataset.urgent === 'true';
    document.getElementById('taskGroup').value = task.dataset.group || '';
  }
}

function closeTaskModal() {
  console.log('Closing task modal');
  document.getElementById('taskModal').classList.remove('show');
  editingTask = null;
}

function saveTask() {
  const taskName = document.getElementById('taskName').value.trim();
  const important = document.getElementById('important').checked;
  const urgent = document.getElementById('urgent').checked;
  const group = document.getElementById('taskGroup').value;
  
  if (!taskName) {
    alert('Please enter a task name');
    return;
  }
  
  // Determine quadrant
  let quadrantId;
  if (important && urgent) quadrantId = 'q1';
  else if (important && !urgent) quadrantId = 'q2';
  else if (!important && urgent) quadrantId = 'q3';
  else quadrantId = 'q4';
  
  const quadrant = document.getElementById(quadrantId);
  const quadrantContent = quadrant.querySelector('.quadrant-content');
  
  if (editingTask) {
    // Update existing task
    editingTask.dataset.name = taskName;
    editingTask.dataset.important = important;
    editingTask.dataset.urgent = urgent;
    editingTask.dataset.group = group;
    
    const taskLeft = editingTask.querySelector('.task-left');
    const existingDot = taskLeft.querySelector('.group-dot');
    
    if (group && groups[group]) {
      if (existingDot) {
        existingDot.style.background = groups[group];
      } else {
        const dot = document.createElement('span');
        dot.className = 'group-dot';
        dot.style.background = groups[group];
        taskLeft.insertBefore(dot, taskLeft.firstChild);
      }
    } else if (existingDot) {
      existingDot.remove();
    }
    
    taskLeft.querySelector('span:last-child').textContent = taskName;
    
  } else {
    // Create new task
    const task = document.createElement('div');
    task.className = 'task';
    task.draggable = true;
    task.dataset.name = taskName;
    task.dataset.important = important;
    task.dataset.urgent = urgent;
    task.dataset.group = group;
    
    const taskLeft = document.createElement('div');
    taskLeft.className = 'task-left';
    
    if (group && groups[group]) {
      const dot = document.createElement('span');
      dot.className = 'group-dot';
      dot.style.background = groups[group];
      taskLeft.appendChild(dot);
    }
    
    const taskNameSpan = document.createElement('span');
    taskNameSpan.textContent = taskName;
    taskLeft.appendChild(taskNameSpan);
    
    const taskMenu = document.createElement('div');
    taskMenu.className = 'task-menu';
    
    const dots = document.createElement('span');
    dots.className = 'dots';
    dots.textContent = '⋮';
    dots.onclick = (e) => {
      e.stopPropagation();
      const menu = e.target.nextElementSibling;
      menu.classList.toggle('show');
    };
    
    const menu = document.createElement('div');
    menu.className = 'menu';
    
    const editOption = document.createElement('div');
    editOption.textContent = 'Edit';
    editOption.onclick = () => {
      openTaskModal(task);
      menu.classList.remove('show');
    };
    
    const deleteOption = document.createElement('div');
    deleteOption.textContent = 'Delete';
    deleteOption.onclick = () => {
      task.remove();
      saveToStorage();
      menu.classList.remove('show');
    };
    
    menu.appendChild(editOption);
    menu.appendChild(deleteOption);
    taskMenu.appendChild(dots);
    taskMenu.appendChild(menu);
    
    task.appendChild(taskLeft);
    task.appendChild(taskMenu);
    
    // Add drag events
    task.addEventListener('dragstart', () => {
      task.classList.add('dragging');
    });
    
    task.addEventListener('dragend', () => {
      task.classList.remove('dragging');
    });
    
    // Add to group or quadrant
    if (group && groups[group]) {
      let groupContainer = quadrant.querySelector(`.group-container[data-name="${group}"]`);
      if (!groupContainer) {
        groupContainer = createGroupContainer(group, quadrant);
      }
      groupContainer.querySelector('.group-tasks').appendChild(task);
    } else {
      quadrantContent.appendChild(task);
    }
  }
  
  saveToStorage();
  closeTaskModal();
}

// ============================================
// GROUP MANAGEMENT
// ============================================
function createGroupContainer(groupName, quadrant) {
  const groupContainer = document.createElement('div');
  groupContainer.className = 'group-container';
  groupContainer.dataset.name = groupName;
  groupContainer.draggable = true;
  
  const header = document.createElement('div');
  header.className = 'group-header';
  header.style.background = groups[groupName];
  
  const headerLeft = document.createElement('div');
  headerLeft.className = 'group-header-left';
  
  const nameSpan = document.createElement('span');
  nameSpan.textContent = groupName;
  headerLeft.appendChild(nameSpan);
  
  const menuContainer = document.createElement('div');
  menuContainer.className = 'group-menu';
  
  const dots = document.createElement('span');
  dots.className = 'group-dots';
  dots.textContent = '⋮';
  dots.onclick = (e) => {
    e.stopPropagation();
    const menu = e.target.nextElementSibling;
    menu.classList.toggle('show');
  };
  
  const menu = document.createElement('div');
  menu.className = 'group-menu-content';
  
  const editOption = document.createElement('div');
  editOption.textContent = 'Edit Group';
  editOption.onclick = () => {
    openEditGroupModal(groupName);
    menu.classList.remove('show');
  };
  
  const deleteOption = document.createElement('div');
  deleteOption.textContent = 'Delete Group';
  deleteOption.onclick = () => {
    openDeleteGroupModal(groupName);
    menu.classList.remove('show');
  };
  
  menu.appendChild(editOption);
  menu.appendChild(deleteOption);
  menuContainer.appendChild(dots);
  menuContainer.appendChild(menu);
  
  header.appendChild(headerLeft);
  header.appendChild(menuContainer);
  
  const tasksContainer = document.createElement('div');
  tasksContainer.className = 'group-tasks';
  
  groupContainer.appendChild(header);
  groupContainer.appendChild(tasksContainer);
  
  // Add drag events
  groupContainer.addEventListener('dragstart', (e) => {
    if (e.target.classList.contains('group-dots')) {
      e.preventDefault();
      return;
    }
    groupContainer.classList.add('dragging');
  });
  
  groupContainer.addEventListener('dragend', () => {
    groupContainer.classList.remove('dragging');
  });
  
  quadrant.querySelector('.quadrant-content').appendChild(groupContainer);
  return groupContainer;
}

function openGroupModal() {
  console.log('Opening group modal');
  editingGroup = null;
  document.getElementById('groupModalTitle').textContent = 'Add Group';
  document.getElementById('groupName').value = '';
  document.getElementById('groupColor').value = '#667eea';
  document.getElementById('saveGroupBtn').textContent = 'Add Group';
  document.getElementById('groupModal').classList.add('show');
}

function closeGroupModal() {
  console.log('Closing group modal');
  document.getElementById('groupModal').classList.remove('show');
  editingGroup = null;
}

function saveGroup() {
  const groupName = document.getElementById('groupName').value.trim();
  const groupColor = document.getElementById('groupColor').value;
  
  if (!groupName) {
    alert('Please enter a group name');
    return;
  }
  
  if (editingGroup) {
    // Update existing group
    const oldName = editingGroup;
    const newName = groupName;
    
    // Update groups object
    delete groups[oldName];
    groups[newName] = groupColor;
    
    // Update all group containers
    document.querySelectorAll(`.group-container[data-name="${oldName}"]`).forEach(container => {
      container.dataset.name = newName;
      const header = container.querySelector('.group-header');
      header.style.background = groupColor;
      header.querySelector('.group-header-left span').textContent = newName;
      
      // Update menu event handlers
      const editBtn = container.querySelector('.group-menu-content div:first-child');
      const deleteBtn = container.querySelector('.group-menu-content div:last-child');
      editBtn.onclick = () => openEditGroupModal(newName);
      deleteBtn.onclick = () => openDeleteGroupModal(newName);
    });
    
    // Update all tasks in this group
    document.querySelectorAll(`.task[data-group="${oldName}"]`).forEach(task => {
      task.dataset.group = newName;
      const dot = task.querySelector('.group-dot');
      if (dot) {
        dot.style.background = groupColor;
      }
    });
    
    // Update dropdown
    const option = document.querySelector(`#taskGroup option[value="${oldName}"]`);
    if (option) {
      option.value = newName;
      option.textContent = newName;
    }
    
  } else {
    // Add new group
    groups[groupName] = groupColor;
    
    // Add to dropdown
    const option = document.createElement('option');
    option.value = groupName;
    option.textContent = groupName;
    document.getElementById('taskGroup').appendChild(option);
  }
  
  saveToStorage();
  closeGroupModal();
}

function openEditGroupModal(groupName) {
  editingGroup = groupName;
  document.getElementById('groupModalTitle').textContent = 'Edit Group';
  document.getElementById('groupName').value = groupName;
  document.getElementById('groupColor').value = groups[groupName];
  document.getElementById('saveGroupBtn').textContent = 'Save Changes';
  document.getElementById('groupModal').classList.add('show');
}

function openDeleteGroupModal(groupName) {
  deletingGroup = groupName;
  document.getElementById('deleteGroupName').textContent = groupName;
  document.getElementById('deleteGroupModal').classList.add('show');
}

function closeDeleteGroupModal() {
  document.getElementById('deleteGroupModal').classList.remove('show');
  deletingGroup = null;
}

function confirmDeleteGroup() {
  if (!deletingGroup) return;
  
  const deleteOption = document.querySelector('input[name="deleteOption"]:checked').value;
  const groupName = deletingGroup;
  
  // Find all group containers
  const groupContainers = document.querySelectorAll(`.group-container[data-name="${groupName}"]`);
  
  groupContainers.forEach(container => {
    if (deleteOption === 'deleteTasks') {
      // Delete all tasks
      container.querySelectorAll('.task').forEach(task => task.remove());
    } else {
      // Move tasks out of group
      const tasks = container.querySelectorAll('.task');
      const quadrant = container.closest('.quadrant');
      const quadrantContent = quadrant.querySelector('.quadrant-content');
      
      tasks.forEach(task => {
        task.dataset.group = '';
        const dot = task.querySelector('.group-dot');
        if (dot) dot.remove();
        quadrantContent.appendChild(task);
      });
    }
    
    // Remove group container
    container.remove();
  });
  
  // Remove from groups object
  delete groups[groupName];
  
  // Remove from dropdown
  const option = document.querySelector(`#taskGroup option[value="${groupName}"]`);
  if (option) option.remove();
  
  saveToStorage();
  closeDeleteGroupModal();
}

// ============================================
// DATA PERSISTENCE
// ============================================
function saveToStorage() {
  const data = getCurrentData();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  
  // Auto-sync to Google Drive if signed in
  if (googleUser && !syncInProgress) {
    if (window.syncTimeout) {
      clearTimeout(window.syncTimeout);
    }
    window.syncTimeout = setTimeout(() => {
      forceSyncToDrive();
    }, 2000);
  }
}

function getCurrentData() {
  const tasks = [];
  const quadrants = ['q1', 'q2', 'q3', 'q4'];
  
  quadrants.forEach(quadrantId => {
    const quadrant = document.getElementById(quadrantId);
    const tasksInQuadrant = quadrant.querySelectorAll('.task');
    
    tasksInQuadrant.forEach(task => {
      tasks.push({
        name: task.dataset.name,
        important: task.dataset.important === 'true',
        urgent: task.dataset.urgent === 'true',
        group: task.dataset.group || '',
        quadrant: quadrantId
      });
    });
  });
  
  return {
    version: FILE_VERSION,
    timestamp: new Date().toISOString(),
    groups: { ...groups },
    tasks: tasks
  };
}

function loadData(data) {
  // Clear current data
  document.querySelectorAll('.quadrant .quadrant-content').forEach(content => {
    content.innerHTML = '';
  });
  
  // Load groups
  groups = data.groups || {};
  
  // Update dropdown
  const select = document.getElementById('taskGroup');
  select.innerHTML = '<option value="">No Group</option>';
  Object.keys(groups).forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name;
    select.appendChild(option);
  });
  
  // Load tasks
  if (data.tasks && Array.isArray(data.tasks)) {
    data.tasks.forEach(taskData => {
      // This is a simplified version - in practice you would recreate tasks
      // For now, we'll rely on localStorage
    });
  }
}

// ============================================
// GOOGLE DRIVE SYNC
// ============================================
function toggleSyncOptions() {
  document.getElementById('syncOptions').classList.toggle('show');
}

// Close sync options when clicking elsewhere
document.addEventListener('click', (e) => {
  if (!e.target.closest('.sync-options-container')) {
    document.getElementById('syncOptions').classList.remove('show');
  }
});

function signInWithGoogle() {
  alert('Google Drive sync requires API configuration.\n\nTo enable sync:\n1. Get Google API keys from Google Cloud Console\n2. Replace clientId and apiKey in the code\n3. Configure OAuth consent screen');
  
  // Simulate sign-in for demo
  googleUser = { access_token: 'demo', email: 'demo@example.com' };
  updateAuthUI(true);
  updateSyncStatus('Online (Demo)');
}

function signOutFromGoogle() {
  googleUser = null;
  updateAuthUI(false);
  updateSyncStatus('Offline');
}

function forceSyncToDrive() {
  if (!googleUser) {
    alert('Please sign in first');
    return;
  }
  
  updateSyncStatus('Syncing...');
  setTimeout(() => {
    updateSyncStatus('Synced (Demo)');
  }, 1000);
}

function loadFromDrive() {
  if (!googleUser) {
    alert('Please sign in first');
    return;
  }
  
  updateSyncStatus('Loading...');
  setTimeout(() => {
    alert('Google Drive sync is in demo mode.\n\nTo enable real sync:\n1. Get Google API keys\n2. Configure OAuth\n3. Replace demo functions with real API calls');
    updateSyncStatus('Online (Demo)');
  }, 1000);
}

function updateAuthUI(isSignedIn) {
  if (isSignedIn) {
    document.getElementById('signInBtn').style.display = 'none';
    document.getElementById('signOutBtn').style.display = 'block';
    document.getElementById('googleDriveBtn').classList.add('signed-in');
    document.getElementById('driveBtnText').textContent = 'Synced';
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('userName').textContent = 'Demo User';
  } else {
    document.getElementById('signInBtn').style.display = 'block';
    document.getElementById('signOutBtn').style.display = 'none';
    document.getElementById('googleDriveBtn').classList.remove('signed-in');
    document.getElementById('driveBtnText').textContent = 'Sync with Drive';
    document.getElementById('userInfo').style.display = 'none';
  }
}

function updateSyncStatus(status) {
  const el = document.getElementById('syncStatus');
  el.textContent = status;
  el.className = 'sync-status';
  
  if (status.includes('Syncing') || status.includes('Loading')) {
    el.classList.add('syncing');
  } else if (status.includes('Synced') || status.includes('Online')) {
    el.classList.add('online');
  } else {
    el.classList.add('offline');
  }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================
function clearAllData() {
  if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
    localStorage.removeItem(STORAGE_KEY);
    
    // Clear UI
    document.querySelectorAll('.quadrant .quadrant-content').forEach(content => {
      content.innerHTML = '';
    });
    
    // Reset groups
    groups = {};
    document.getElementById('taskGroup').innerHTML = '<option value="">No Group</option>';
    
    // Reset Google auth
    if (googleUser) {
      signOutFromGoogle();
    }
    
    alert('All data cleared successfully!');
  }
}

// ============================================
// START THE APP
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM loaded, initializing app...');
  initializeApp();
  
  // Close modals when clicking outside
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });
  });
  
  // Close menus when clicking elsewhere
  document.addEventListener('click', () => {
    document.querySelectorAll('.menu.show, .group-menu-content.show').forEach(menu => {
      menu.classList.remove('show');
    });
  });
  
  console.log('App started successfully');
});
</script>
</body>
</html>
